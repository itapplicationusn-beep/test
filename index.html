<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Groundwater GIS Dashboard (Deployable)</title>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <!-- Leaflet Draw -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
  <!-- Simple layout styles -->
  <style>
    :root{--sidebar-width:360px;--gap:12px}
    html,body,#app{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Arial}
    #app{display:grid;grid-template-columns:var(--sidebar-width) 1fr;gap:var(--gap)}
    #sidebar{padding:12px;box-sizing:border-box;border-right:1px solid #e6e6e6;overflow:auto}
    #map{height:100vh;width:100%}
    h2{margin:8px 0}
    .control-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .btn{padding:8px 10px;border-radius:6px;border:1px solid #ccc;background:#f7f7f7;cursor:pointer}
    .btn.primary{background:#2563eb;color:white;border-color:#1e40af}
    label{font-size:13px}
    input[type=range]{width:100%}
    .small{font-size:13px;color:#555}
    #chartContainer{height:200px}
    .legend-item{display:flex;align-items:center;gap:8px;margin:6px 0}
    .dot{width:14px;height:14px;border-radius:50%}
    .file-input{display:block}
    .row{display:flex;gap:8px}
    .flex-1{flex:1}
    .footer-note{font-size:12px;color:#666;margin-top:12px}
    .toggle{display:inline-flex;align-items:center;gap:6px}
    .search-results{max-height:120px;overflow:auto;border:1px solid #eee;padding:6px;border-radius:6px}
    /* responsive */
    @media(max-width:900px){#app{grid-template-columns:1fr}#sidebar{height:40vh;position:relative}}
  </style>
</head>
<body>
<div id="app">
  <div id="sidebar">
    <h2>Groundwater GIS Dashboard</h2>
    <div class="control-row">
      <button id="btnLocate" class="btn">My Location</button>
      <button id="btnClear" class="btn">Clear Drawings</button>
    </div>

    <h3>1) Data & Upload</h3>
    <div class="small">Upload CSV with header: name,lat,lng,ph,tds,date (date optional)</div>
    <input id="file" class="file-input" type="file" accept="text/csv,application/vnd.ms-excel,application/json" />
    <div style="margin-top:8px" class="row">
      <button id="btnLoadSample" class="btn">Load Sample</button>
      <button id="btnExport" class="btn">Export CSV</button>
    </div>

    <h3>2) Search</h3>
    <input id="searchBox" placeholder="Search by name..." style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc" />
    <div id="searchResults" class="search-results"></div>

    <h3>3) Filters</h3>
    <label>pH range <span id="phLabel" class="small">(any)</span></label>
    <div class="row">
      <input id="phMin" type="number" step="0.1" placeholder="min" style="width:100%" />
      <input id="phMax" type="number" step="0.1" placeholder="max" style="width:100%" />
    </div>

    <label style="margin-top:8px">TDS range (mg/L) <span id="tdsLabel" class="small">(any)</span></label>
    <div class="row">
      <input id="tdsMin" type="number" placeholder="min" style="width:100%" />
      <input id="tdsMax" type="number" placeholder="max" style="width:100%" />
    </div>
    <div style="margin-top:8px" class="row">
      <button id="btnApplyFilters" class="btn primary">Apply</button>
      <button id="btnResetFilters" class="btn">Reset</button>
    </div>

    <h3>4) Layers</h3>
    <div class="small">Base & WMS layers (toggle)</div>
    <div style="margin:8px 0">
      <label class="toggle"><input type="checkbox" id="cbImagery"/> World Imagery (ESRI)</label><br>
      <label class="toggle"><input type="checkbox" id="cbGIBS"/> NASA GIBS (VIIRS/Fire)</label><br>
      <label class="toggle"><input type="checkbox" id="cbBhuvan"/> Bhuvan WMS (example)</label>
    </div>

    <h3>5) Heatmap & Legend</h3>
    <label>Heatmap slider (radius)</label>
    <input id="heatRadius" type="range" min="5" max="50" value="25" />
    <div style="margin-top:8px">
      <button id="btnToggleHeat" class="btn">Toggle Heatmap</button>
    </div>
    <div style="margin-top:8px">
      <strong>Legend (pH)</strong>
      <div class="legend-item"><div class="dot" style="background:#2b8cbe"></div><div class="small">pH &lt; 6.5 (Acid)</div></div>
      <div class="legend-item"><div class="dot" style="background:#7fbf7b"></div><div class="small">6.5 ≤ pH ≤ 8.5 (Normal)</div></div>
      <div class="legend-item"><div class="dot" style="background:#fdae61"></div><div class="small">pH &gt; 8.5 (Alkaline)</div></div>
    </div>

    <h3>6) Charts</h3>
    <div id="chartContainer"><canvas id="chart"></canvas></div>

    <h3>7) Database / Save</h3>
    <div class="small">You can hook Firebase or Supabase. See the code comments for placeholders.</div>
    <div style="margin-top:8px" class="row">
      <button id="btnSaveFirebase" class="btn">Save to Firebase</button>
      <button id="btnSaveLocal" class="btn">Save Locally</button>
    </div>

    <div class="footer-note">Deploy: upload this single file to any web server. For Firebase save, add your Firebase config where indicated.</div>
  </div>

  <div id="map"></div>
</div>

<!-- Libraries -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
<!-- Firebase SDK (optional) - add your config to use -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/*
  Full single-file Groundwater GIS Dashboard.
  Features implemented:
   1) Search box (client-side) + result list
   2) Filters for pH and TDS
   3) WMS layers toggles (examples provided)
   4) Upload CSV/JSON and show points (PapaParse)
   5) Heatmap (leaflet.heat) toggle + radius
   6) Drawing tools (leaflet.draw) + clear drawings
   7) Firebase placeholder save (needs config)
   8) Dashboard layout + Chart.js for pH/TDS
   9) Geolocation button to center map
  10) Full deployable single HTML file

  To deploy: save as index.html and upload to any web server.
*/

// --- Map init ---
var map = L.map('map').setView([30.3165,78.0322],8);
// OSM basemap
var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'© OpenStreetMap'}).addTo(map);
// optional imagery (ESRI) - used as overlay
var esriImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');

// WMS examples
var gibsLayer = L.tileLayer('https://gibs.earthdata.nasa.gov/wms/epsg3857/best/wms.cgi', {layers:'VIIRS_SNPP_DayNightBand_ENHANCED',format:'image/png',transparent:true,attribution:'NASA GIBS'});
var bhuvanWms = L.tileLayer.wms('https://bhuvan.nrsc.gov.in/geoserver/bhuvan/wms', {layers:'bhuvan:WATERBODY_MANDATORY',format:'image/png',transparent:true,attribution:'Bhuvan (example)'});

// Layer groups for markers and heatmap
var markersLayer = L.layerGroup().addTo(map);
var drawnItems = new L.FeatureGroup().addTo(map);
var heatLayer = L.heatLayer([], {radius:25,blur:15}).addTo(map);
var heatOn = false;

// --- Leaflet.draw ---
var drawControl = new L.Control.Draw({position:'topright',draw:{circle:false,marker:true,polyline:true,polygon:true,rectangle:true},edit:{featureGroup:drawnItems}});
map.addControl(drawControl);
map.on(L.Draw.Event.CREATED, function(e){
  var layer = e.layer; drawnItems.addLayer(layer);
});

// Clear drawings button
document.getElementById('btnClear').addEventListener('click', function(){ drawnItems.clearLayers(); });

// --- Sample data (array of objects) ---
var samplePoints = [
  {name:'Well A',lat:30.316, lng:78.032, ph:7.1, tds:320, date:'2025-11-20'},
  {name:'Well B',lat:30.5, lng:78.2, ph:6.4, tds:480, date:'2025-11-18'},
  {name:'Well C',lat:29.9, lng:78.1, ph:8.8, tds:210, date:'2025-11-21'},
  {name:'Well D',lat:30.2, lng:77.9, ph:7.8, tds:150, date:'2025-11-22'}
];
var allPoints = []; // master list

// --- Utility: marker color by pH ---
function colorByPH(p){
  if(p < 6.5) return '#2b8cbe';
  if(p <= 8.5) return '#7fbf7b';
  return '#fdae61';
}

// --- Render points on map ---
function renderPoints(points){
  markersLayer.clearLayers();
  heatLayer.setLatLngs([]);
  points.forEach(p => {
    var marker = L.circleMarker([p.lat,p.lng],{radius:8,fillOpacity:0.9,color:'#333',fillColor:colorByPH(p.ph)});
    marker.bindPopup(`<b>${p.name || 'Point'}</b><br>pH: ${p.ph}<br>TDS: ${p.tds}<br>${p.date?('Date: '+p.date):''}`);
    marker.options.data = p; // attach
    markersLayer.addLayer(marker);
    heatLayer.addLatLng([p.lat,p.lng, p.tds || 1]);
  });
  // update search list
  updateSearchResults(points);
  // update chart
  updateChart(points);
}

// --- Filters ---
function applyFilters(){
  var phMin = parseFloat(document.getElementById('phMin').value);
  var phMax = parseFloat(document.getElementById('phMax').value);
  var tdsMin = parseFloat(document.getElementById('tdsMin').value);
  var tdsMax = parseFloat(document.getElementById('tdsMax').value);
  document.getElementById('phLabel').innerText = (isNaN(phMin)?'':'min '+phMin) + ' — ' + (isNaN(phMax)?'':'max '+phMax);
  document.getElementById('tdsLabel').innerText = (isNaN(tdsMin)?'':'min '+tdsMin) + ' — ' + (isNaN(tdsMax)?'':'max '+tdsMax);
  var filtered = allPoints.filter(p => {
    if(!isNaN(phMin) && p.ph < phMin) return false;
    if(!isNaN(phMax) && p.ph > phMax) return false;
    if(!isNaN(tdsMin) && p.tds < tdsMin) return false;
    if(!isNaN(tdsMax) && p.tds > tdsMax) return false;
    return true;
  });
  renderPoints(filtered);
}

function resetFilters(){
  document.getElementById('phMin').value = '';
  document.getElementById('phMax').value = '';
  document.getElementById('tdsMin').value = '';
  document.getElementById('tdsMax').value = '';
  document.getElementById('phLabel').innerText='(any)';
  document.getElementById('tdsLabel').innerText='(any)';
  renderPoints(allPoints);
}

document.getElementById('btnApplyFilters').addEventListener('click', applyFilters);
document.getElementById('btnResetFilters').addEventListener('click', resetFilters);

// --- Search ---
var searchBox = document.getElementById('searchBox');
var searchResults = document.getElementById('searchResults');
searchBox.addEventListener('input', function(){
  var q = this.value.trim().toLowerCase();
  if(!q){ updateSearchResults(allPoints); return; }
  var results = allPoints.filter(p => (p.name||'').toLowerCase().includes(q));
  updateSearchResults(results);
});

function updateSearchResults(points){
  searchResults.innerHTML = '';
  if(!points || points.length === 0){ searchResults.innerHTML = '<div class="small">No results</div>'; return; }
  points.slice(0,200).forEach(p => {
    var div = document.createElement('div'); div.className='small'; div.style.padding='6px'; div.style.cursor='pointer';
    div.innerHTML = `<b>${p.name||'Point'}</b> <span style="color:#666">(pH:${p.ph}, TDS:${p.tds})</span>`;
    div.onclick = function(){ map.setView([p.lat,p.lng],14); }
    searchResults.appendChild(div);
  });
}

// --- Heatmap controls ---
var heatRadius = document.getElementById('heatRadius');
heatRadius.addEventListener('input', function(){ heatLayer.setOptions({radius: parseInt(this.value)}); });
document.getElementById('btnToggleHeat').addEventListener('click', function(){ heatOn = !heatOn; if(heatOn) heatLayer.addTo(map); else map.removeLayer(heatLayer); this.innerText = heatOn? 'Hide Heatmap':'Show Heatmap'; });

// --- Load sample ---
document.getElementById('btnLoadSample').addEventListener('click', function(){ allPoints = samplePoints.slice(); renderPoints(allPoints); });

// --- CSV/JSON upload ---
document.getElementById('file').addEventListener('change', function(e){
  var f = e.target.files[0]; if(!f) return;
  var name = f.name.toLowerCase();
  if(name.endsWith('.csv') || name.endsWith('.txt')){
    Papa.parse(f, {header:true,skipEmptyLines:true,complete:function(res){
      var rows = res.data.map(r => ({name:r.name||r.Name||r.id||'Point', lat:parseFloat(r.lat||r.Lat||r.latitude), lng:parseFloat(r.lng||r.Lng||r.longitude), ph:parseFloat(r.ph||r.pH||r.ph_value), tds:parseFloat(r.tds||r.TDS), date:r.date||r.Date})).filter(x=>!isNaN(x.lat) && !isNaN(x.lng));
      allPoints = allPoints.concat(rows);
      renderPoints(allPoints);
    }});
  } else if(name.endsWith('.json')){
    var reader = new FileReader(); reader.onload = function(){
      try{ var js = JSON.parse(reader.result); allPoints = allPoints.concat(js); renderPoints(allPoints); }catch(err){alert('Invalid JSON');}
    }; reader.readAsText(f);
  } else alert('Unsupported file type');
});

// --- Export CSV ---
document.getElementById('btnExport').addEventListener('click', function(){
  if(allPoints.length===0){ alert('No data to export'); return; }
  var csv = 'name,lat,lng,ph,tds,date\n' + allPoints.map(p=>`${(p.name||'').replace(/,/g,' ')} , ${p.lat}, ${p.lng}, ${p.ph||''}, ${p.tds||''}, ${p.date||''}`).join('\n');
  var blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  var url = URL.createObjectURL(blob); var a = document.createElement('a'); a.href = url; a.download = 'groundwater_export.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

// --- Chart ---
var chartCtx = document.getElementById('chart').getContext('2d');
var chart = new Chart(chartCtx, {type:'bar',data:{labels:[],datasets:[{label:'TDS (mg/L)',data:[],yAxisID:'y'},{label:'pH',data:[],yAxisID:'y1'}]},options:{responsive:true,interaction:{mode:'index'},scales:{y:{type:'linear',position:'left'},y1:{type:'linear',position:'right',grid:{display:false}}}}});
function updateChart(points){
  var labels = points.map(p=>p.name||'P');
  chart.data.labels = labels;
  chart.data.datasets[0].data = points.map(p=>p.tds||0);
  chart.data.datasets[1].data = points.map(p=>p.ph||0);
  chart.update();
}

// --- Firebase Save (placeholder) ---
// To enable: create Firebase project, enable Realtime Database, then paste config below.
var firebaseEnabled = false; // change to true if you add config
// Example config format (replace values):
/*
var firebaseConfig = {
  apiKey: "XXX",
  authDomain: "XXX",
  databaseURL: "https://YOUR-PROJECT.firebaseio.com",
  projectId: "YOUR-PROJECT",
  storageBucket: "YOUR-PROJECT.appspot.com",
  messagingSenderId: "...",
  appId: "..."
};
firebase.initializeApp(firebaseConfig);
var db = firebase.database();
*/

document.getElementById('btnSaveFirebase').addEventListener('click', function(){
  if(!firebaseEnabled){ alert('Firebase not configured. See code comments to add your Firebase config.'); return; }
  // sample write
  allPoints.forEach(p=>{ var ref = db.ref('groundwater').push(); ref.set(p); });
  alert('Saved to Firebase');
});

// Save locally (IndexedDB/localStorage simple)
document.getElementById('btnSaveLocal').addEventListener('click', function(){
  localStorage.setItem('groundwater_data', JSON.stringify(allPoints)); alert('Saved locally (browser)');
});

// --- Geolocation ---
document.getElementById('btnLocate').addEventListener('click', function(){
  if(navigator.geolocation){ navigator.geolocation.getCurrentPosition(function(pos){ map.setView([pos.coords.latitude,pos.coords.longitude],13); }, function(){ alert('Unable to retrieve location.'); }); } else alert('Geolocation not supported');
});

// --- Layer toggles ---
document.getElementById('cbImagery').addEventListener('change', function(){ if(this.checked) esriImagery.addTo(map); else map.removeLayer(esriImagery); });
document.getElementById('cbGIBS').addEventListener('change', function(){ if(this.checked) gibsLayer.addTo(map); else map.removeLayer(gibsLayer); });
document.getElementById('cbBhuvan').addEventListener('change', function(){ if(this.checked) bhuvanWms.addTo(map); else map.removeLayer(bhuvanWms); });

// --- Map click to add quick point ---
map.on('contextmenu', function(e){ // right click to add quick sample
  var name = prompt('Name for new point (right-click added)'); if(!name) return;
  var ph = parseFloat(prompt('pH value (e.g., 7.2)')); var tds = parseFloat(prompt('TDS mg/L (e.g., 320)'));
  var p = {name:name,lat:e.latlng.lat,lng:e.latlng.lng,ph:isNaN(ph)?null:ph,tds:isNaN(tds)?null:tds,date:new Date().toISOString().slice(0,10)};
  allPoints.push(p); renderPoints(allPoints);
});

// --- Initialize: load saved local data if available or sample ---
var saved = localStorage.getItem('groundwater_data');
if(saved){ try{ allPoints = JSON.parse(saved); renderPoints(allPoints); }catch(e){ allPoints = samplePoints.slice(); renderPoints(allPoints); }} else { allPoints = samplePoints.slice(); renderPoints(allPoints); }

// --- Small UX: click marker center map and open popup on click from list ---
markersLayer.on('click', function(e){ if(e.layer && e.layer.openPopup) e.layer.openPopup(); });

// --- End of script ---
</script>
</body>
</html>
